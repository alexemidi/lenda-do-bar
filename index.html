<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Mentiroso do Bar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&family=Rye&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. VARI√ÅVEIS E RESET
           ========================================= */
        :root {
            --bg-wood: #1a120b;
            --bg-felt: #2c3e50;
            --paper: #e6dcc3;
            --paper-dark: #cbb892;
            --gold: #ffb700;
            --blood: #8a0303;
            --ink: #2b2b2b;
            --shadow: rgba(0,0,0,0.6);
            --chaos: #9c27b0;
            --chaos-light: #e1bee7;
        }

        * { box-sizing: border-box; user-select: none; }
        
        body {
            font-family: 'Roboto Slab', serif;
            background-color: var(--bg-wood);
            background-image: radial-gradient(circle, #2e2218 0%, #0d0905 100%);
            color: var(--paper);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 15px;
        }

        h1, h2, h3, button.western-btn, .western-font {
            font-family: 'Rye', serif;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* =========================================
           2. LAYOUT E UTILIT√ÅRIOS
           ========================================= */
        #app-container { width: 100%; max-width: 450px; position: relative; }

        .screen { display: none; animation: fadeIn 0.4s ease-out; }
        .screen.active { display: block; }

        .text-center { text-align:center; }
        .mt-2 { margin-top:10px; }
        .scroll-content { max-height: 320px; overflow-y: auto; padding-right: 5px; }
        .scroll-content::-webkit-scrollbar { width: 6px; }
        .scroll-content::-webkit-scrollbar-thumb { background: #8d6e63; border-radius: 3px; }

        /* =========================================
           3. COMPONENTES DE UI (Pain√©is, Bot√µes, etc)
           ========================================= */
        /* Painel de Papel Padr√£o */
        .paper-panel {
            background: var(--paper);
            color: var(--ink);
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 0 0 2px #5c4a35, 0 0 0 8px #1a120b, 0 10px 20px var(--shadow);
            margin-bottom: 15px;
            position: relative;
        }
        .paper-panel::after, .paper-panel::before {
            content: ''; position: absolute; top: 10px; width: 8px; height: 8px; 
            background: #3e2723; border-radius: 50%; box-shadow: 0 1px 0 rgba(255,255,255,0.3);
        }
        .paper-panel::before { left: 10px; }
        .paper-panel::after { right: 10px; }

        /* Bot√µes Estilo Western */
        button { cursor: pointer; border: none; outline: none; transition: transform 0.1s, background-color 0.3s, color 0.3s; }
        button:active { transform: scale(0.97); }
        button:disabled { opacity: 0.8; cursor: not-allowed; filter: grayscale(0.2); }

        .western-btn {
            width: 100%;
            padding: 12px;
            margin: 6px 0;
            background: linear-gradient(to bottom, #5d4037, #3e2723);
            color: #ffecd2;
            border: 2px solid #8d6e63;
            border-radius: 4px;
            font-size: 1.1rem;
            text-shadow: 1px 1px 0 #000;
            box-shadow: 0 4px 0 #281813;
        }
        .western-btn.primary { background: linear-gradient(to bottom, #d4af37, #aa8c2c); color: #2e2218; border-color: #fdd835; }
        .western-btn.danger { background: linear-gradient(to bottom, #c62828, #8e0000); border-color: #e57373; }
        .western-btn.secondary { background: linear-gradient(to bottom, #455a64, #263238); border-color: #78909c; }
        .western-btn.small { padding: 5px 10px; font-size: 0.9rem; width: auto; }
        
        /* Bot√£o Atirar Cinza quando desabilitado */
        .western-btn.danger:disabled {
            background: #555;
            border-color: #333;
            color: #aaa;
            filter: none;
            box-shadow: none;
        }

        .western-btn.btn-protect {
            background: #2196F3;
            border-color: #64B5F6;
            color: white;
            transition: all 0.3s ease;
        }
        .western-btn.btn-fire {
            background: linear-gradient(to bottom, #ff5722, #bf360c);
            border-color: #ff8a65;
            color: #fff;
            transition: all 0.3s ease;
        }
        .western-btn.btn-aim {
            background: linear-gradient(to bottom, #7b1fa2, #4a148c);
            border-color: #ce93d8;
            color: #fff;
            transition: all 0.3s ease;
            box-shadow: 0 4px 0 #38006b;
        }

        .btn-black {
            background: #111;
            color: #fff;
            border: 2px solid #444;
            box-shadow: 0 4px 0 #000;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 1.2rem;
            margin-left: 8px;
        }
        .btn-purple {
            background: #4a148c;
            color: #fff;
            border: 2px solid #7b1fa2;
            box-shadow: 0 4px 0 #230b42;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 1.2rem;
            margin-left: 8px;
        }
        
        .help-btn {
            position: absolute; top: 10px; right: 10px; width: 35px; height: 35px;
            border-radius: 50%; background: var(--paper); color: var(--ink);
            font-weight: bold; font-size: 1.2rem; border: 2px solid #3e2723;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); font-family: 'Rye', serif; z-index: 50;
        }

        .tiny-btn { width: 32px; height: 32px; font-weight: bold; border-radius: 4px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(0,0,0,0.3); color: white; }
        .bg-blue { background: #455a64; }
        .bg-red { background: #c62828; }

        /* Setup Slots */
        .slot-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; background: rgba(0,0,0,0.1); padding: 5px; border-radius: 4px; border: 1px dashed #8d6e63; }
        .slot-name { flex: 1; font-weight: bold; font-size: 1.1rem; }

        /* Switches (Massacre e Caos) */
        .switch-container {
            display: flex; align-items: center; justify-content: center;
            gap: 10px; margin: 12px auto; padding: 8px 15px;
            border-radius: 8px; border: 2px solid #5d4037;
            background: rgba(0, 0, 0, 0.35);
            box-shadow: 0 3px 8px rgba(0,0,0,0.7);
            width: fit-content;
        }
        .massacre-label {
            font-family: 'Rye', serif; font-size: 0.95rem; font-weight: 700;
            letter-spacing: 2px; text-transform: uppercase; color: #555; text-align: right;
        }
        .switch { position: relative; display: inline-block; width: 54px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, #5d4037, #3e2723);
            transition: .4s; border: 2px solid #3e2723;
            box-shadow: 0 2px 4px rgba(0,0,0,0.7);
        }
        .slider.before {
            position: absolute; content: ""; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background-color: #cbb892;
            box-shadow: 0 0 4px rgba(0,0,0,0.6); transition: .4s;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background-color: #cbb892;
            box-shadow: 0 0 4px rgba(0,0,0,0.6); transition: .4s;
        }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        
        /* Estilos do Modo Massacre (Fogo) */
        input:checked + .slider {
            background: radial-gradient(circle at 20% 50%, #ffe0b2, #ff9800, #bf360c);
            border-color: #ffb74d;
            box-shadow: 0 0 4px rgba(255, 111, 0, 0.9), 0 0 10px rgba(255, 87, 34, 0.8), 0 0 18px rgba(255, 160, 0, 0.6);
        }
        input:checked + .slider:before {
            transform: translateX(24px); background-color: #fff3e0;
            box-shadow: 0 0 6px rgba(255, 249, 196, 0.9);
        }
        input:disabled + .slider { opacity: 0.5; cursor: not-allowed; }

        .switch-container:not(.chaos-style):has(input:checked) {
            border-color: #ffb700;
            background: linear-gradient(135deg, #100a08 30%, #3e1f18 100%);
            animation: flamePulse 1.4s infinite ease-in-out;
        }
        .switch-container:not(.chaos-style):has(input:checked) .massacre-label {
            color: #ffb700;
            text-shadow: 0 0 5px rgba(255, 183, 0, 0.8), 0 0 10px rgba(255, 69, 0, 0.6);
        }

        /* Estilos do Modo Caos (Roxo) */
        .switch-container.chaos-style:has(input:checked) {
            border-color: var(--chaos);
            background: linear-gradient(135deg, #1a0f1f 30%, #2e1b33 100%);
            box-shadow: 0 0 10px rgba(156, 39, 176, 0.4);
        }
        .switch-container.chaos-style:has(input:checked) .massacre-label {
            color: var(--chaos-light);
            text-shadow: 0 0 5px var(--chaos);
        }
        .switch-container.chaos-style input:checked + .slider {
            background: radial-gradient(circle at 20% 50%, #e1bee7, #9c27b0, #4a148c);
            border-color: #ce93d8;
            box-shadow: 0 0 4px rgba(156, 39, 176, 0.9);
        }

        /* Jogo & Cartas */
        .mesa-info { text-align: center; margin-bottom: 10px; }
        .card-wrapper-padding { padding: 15px; overflow: visible; }
        .card-display { 
            width: 100px; height: 140px; margin: 0 auto 15px; 
            background-color: transparent; background-size: cover; background-position: center; 
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); 
            filter: sepia(0.3) contrast(1.1); position: relative; 
        }
        .flip-container { perspective: 1000px; margin: 0 auto; width: 140px; height: 210px; }
        .flipper { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.3s ease; }
        .front, .back { 
            position: absolute; width: 140px; height: 210px; left: 50%; top: 0; 
            transform: translateX(-50%); backface-visibility: hidden; 
            border-radius: 8px; background-size: cover; 
        }
        .front { transform: translateX(-50%) rotateY(180deg); } 
        .back { transform: translateX(-50%) rotateY(0deg); background-image: url('src/assets/imgs/card-back.png'); }

        .narrator-box { 
            font-style: italic; text-align: center; color: var(--gold); 
            min-height: 30px; margin-bottom: 5px; text-shadow: 1px 1px 2px #000;
            font-size: 1.15rem; /* Fonte aumentada */
        }
        .player-card { background: #2b2b2b; color: #eee; border-left: 4px solid #555; padding: 10px; margin-bottom: 8px; display:flex; align-items:center; justify-content:space-between; border-radius:0 4px 4px 0; transition: all 0.3s; }
        .player-card.starter { border-left: 4px solid var(--gold); background: #332a1e; }
        .player-card.chaos-highlight { border-left: 4px solid var(--chaos); background: #2a1b2e; box-shadow: 0 0 10px rgba(156, 39, 176, 0.5); }
        .player-card.dead { opacity: 0.6; background: #1a0f0f; border-left: 4px solid #8a0303; text-decoration: line-through; color: #e57373; }
        .emoji-big { font-size: 1.8rem; margin-right: 10px; width: 40px; text-align: center; }
        .log-box { background: rgba(0,0,0,0.5); color:#ccc; font-size:0.85rem; height:80px; overflow-y:auto; padding:5px; margin-top:10px; border-radius:4px; border:1px solid #444; }

        #game-status {
            text-align: center; color: var(--gold); font-weight: bold; 
            min-height: 1.2em; flex: 1;
            font-size: 1.3rem; /* Fonte aumentada */
        }

        /* Estat√≠sticas e Banco de Dados */
        .chalkboard { background: #1a1a1a; border: 8px solid #5d4037; color: rgba(255,255,255,0.9); font-family: 'Courier Prime', monospace; padding: 15px; border-radius: 6px; }
        .chalk-text { color: #eee; border-bottom: 1px dashed #555; padding: 5px 0; display: flex; justify-content: space-between; }
        .ach-row { display:flex; align-items:center; gap:10px; padding:8px; border-bottom:1px solid #ccc; margin-bottom:5px; }
        .ach-row.locked { opacity: 0.5; filter: grayscale(1); }
        .db-row { display:flex; gap:8px; align-items:center; padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.03); }
        .db-name-btn { flex:1; text-align:left; padding:10px; border-radius:6px; background:linear-gradient(#455a64,#2f434a); color:#fff; border:1px solid rgba(0,0,0,0.2); }
        
        /* Bot√£o Expulsar ajustado */
        .db-remove-btn { 
            width: auto; height: 42px; padding: 0 10px;
            border-radius:6px; background:linear-gradient(#c62828,#8e0000); 
            color:#fff; display:flex; align-items:center; justify-content:center;
            font-size: 0.8rem; font-weight: bold; letter-spacing: 1px;
        }

        /* Modais e Toasts */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index:100; display:none; align-items:center; justify-content:center; }
        .modal-overlay.active { display:flex; }
        .wanted-poster { background: var(--paper); color: var(--ink); width: 90%; max-width: 320px; padding:20px; text-align:center; border:4px solid #3e2723; box-shadow: 0 0 30px rgba(0,0,0,0.8); transform: rotate(-2deg); }
        
        .achievement-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.95); border: 2px solid var(--gold); color: #fff; padding: 15px 25px; border-radius: 50px; display:flex; align-items:center; gap:10px; z-index:2000; opacity:0; pointer-events:none; transition: opacity 0.5s, top 0.5s; width:90%; max-width:350px; box-shadow: 0 5px 15px #000; }
        .achievement-toast.show { opacity: 1; top: 40px; }

        .simple-toast {
            position: fixed; top: 25%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); border: 2px solid var(--blood); color: #fff;
            padding: 15px 25px; border-radius: 8px; font-family: 'Rye', serif;
            text-align: center; z-index: 3000; opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease; box-shadow: 0 0 20px rgba(138, 3, 3, 0.6);
            white-space: nowrap;
        }
        .simple-toast.show { opacity: 1; }

        /* =========================================
           4. ESTILOS ESPEC√çFICOS DE TELAS
           ========================================= */
        
        /* Tela de Loading */
        .loading-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .loading-deck-info { 
            font-family: 'Roboto Slab', serif; margin-top: 25px; text-align: center; 
            background: #1a120b; padding: 15px; border-radius: 6px; border: 4px solid #5d4037; 
            outline: 2px dashed var(--gold); outline-offset: -8px; color: #e6dcc3; 
            font-size: 1.1rem; line-height: 1.6; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.8);
        }

        /* Tela de Setup (Estilo Carv√£o) */
        #screen-setup .paper-panel {
            background: #14100e; 
            color: var(--paper);
            border: 1px solid #3e2723;
            box-shadow: 0 0 20px rgba(0,0,0,0.9);
        }
        #screen-setup .paper-panel h2 { color: var(--gold); border-bottom-color: var(--gold) !important; }
        #screen-setup .paper-panel p { color: #bbb; }

        /* =========================================
           5. ANIMA√á√ïES
           ========================================= */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes flamePulse { 
            0% { box-shadow: 0 0 6px rgba(255,140,0,0.4); } 
            50% { box-shadow: 0 0 14px rgba(255,69,0,0.9); } 
            100% { box-shadow: 0 0 6px rgba(255,140,0,0.4); } 
        }
        @keyframes spinCard { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(540deg); } }
        @keyframes shake { 
            10%, 90% { transform: translate3d(-1px, 0, 0); } 
            20%, 80% { transform: translate3d(2px, 0, 0); } 
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 
            40%, 60% { transform: translate3d(4px, 0, 0); } 
        }
        .shake-screen { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        .flip-anim { animation: spinCard 6s ease-in-out forwards; }
        
        .card-animation { 
            position: relative; width: 70px; height: 98px; margin: 20px auto; 
            opacity: 0; animation: fadeIn 0.5s ease-out 0.5s forwards;
        }
        .card-anim {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('src/assets/imgs/card-back.png'); background-size: cover; background-position: center;
            border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.5); animation: shuffle 2.5s infinite ease-in-out;
            border: 1px solid #2e2218;
        }
        .card-anim:nth-child(1) { animation-delay: 0s; z-index: 3; }
        .card-anim:nth-child(2) { animation-delay: 0.25s; z-index: 2; }
        .card-anim:nth-child(3) { animation-delay: 0.5s; z-index: 1; }
        @keyframes shuffle {
            0% { transform: translateX(0) rotate(0); }
            25% { transform: translateX(40px) rotate(15deg); }
            50% { transform: translateX(0) rotate(0); z-index: 1;} 
            75% { transform: translateX(-40px) rotate(-15deg); }
            100% { transform: translateX(0) rotate(0); }
        }
        .pulsate { animation: pulse 1.5s infinite; color: var(--gold); letter-spacing: 2px; text-shadow: 2px 2px 0 #000; }
        @keyframes pulse { 0% { opacity: 0.8; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.8; transform: scale(1); } }

    </style>
</head>
<body>

<div id="app-container">
    <div id="systemToast" class="simple-toast"></div>

    <div id="customModal" class="modal-overlay">
        <div class="wanted-poster">
            <h2 id="modalTitle" style="border-bottom: 2px solid #000; padding-bottom:5px;">AVISO</h2>
            <p id="modalMessage" style="font-size: 1.1rem; margin: 15px 0;">Mensagem aqui</p>
            <div id="modalActions" style="display: flex; gap: 10px; justify-content: center;"></div>
        </div>
    </div>

    <div id="achievementToast" class="achievement-toast">
        <span id="achEmoji" style="font-size: 2rem;">üèÜ</span>
        <div style="text-align: left;">
            <div id="achPlayerName" style="color: var(--gold); font-weight: bold; font-size: 0.9rem;">JOGADOR</div>
            <div style="font-size: 0.8rem; text-transform: uppercase;">Desbloqueou:</div>
            <div id="achName" style="font-weight: bold;">Nome da Conquista</div>
        </div>
    </div>

    <div id="screen-start" class="screen active">
        <div class="paper-panel text-center">
            <h1 style="font-size: 2.2rem; color: #3e2723; margin-bottom: 5px;">O MENTIROSO</h1>
            <h2 style="font-size: 1.5rem; color: var(--blood);">DO BAR</h2>
            <p style="font-style: italic; margin-top: 10px;">"A verdade liberta, mas a mentira embebeda."</p>
        </div>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="western-btn primary" onclick="App.goTo('setup')">JOGAR</button>
            <button class="western-btn secondary" onclick="App.goTo('stats')">ESTAT√çSTICAS</button>
            <button class="western-btn secondary" onclick="App.goTo('rules')">REGRAS</button>
        </div>
    </div>

    <div id="screen-rules" class="screen">
        <div class="paper-panel">
            <h2 class="text-center" style="border-bottom: 2px solid #000;">COMO JOGAR</h2>
            <div class="scroll-content" style="font-size: 0.95rem; line-height: 1.5;">
                <p><b>1. O Baralho:</b> Cada jogador recebe 5 cartas. Usem um baralho f√≠sico composto por:</p>
                <ul>
                    <li><b>At√© 4 jogadores - 20 cartas:</b> 6 Reis, 6 Damas, 6 Ases e 2 Coringas/ at√© 1 especial* (Opcional).</li>
                    <li><b>At√© 5 jogadores - 25 cartas:</b> 7 Reis, 7 Damas, 7 Ases e 3 Coringas/ at√© 2 especiais* (Opcionais).</li>
                    <li><b>At√© 6 jogadores - 30 cartas:</b> 8 Reis, 8 Damas, 8 Ases, 2 Coringas e especiais* (Obrigat√≥rio).</li>
                </ul>

                <p><b>2. A Rodada:</b> O jogo sorteia a carta da mesa (ex: Rei). O jogador da vez deve jogar de 1 a 3 cartas viradas para baixo e anunciar: "Um Rei", "Dois Reis", etc.</p>
                <p><b>3. O Coringa:</b> O coringa funciona como a carta da mesa. Perfeito para enganar os desatentos. <b>OBS:</b> As cartas especiais entram no lugar do coringa se algum modo especial estiver ligado.</p>
                <p><b>4. O Blefe:</b> Ele pode estar mentindo! Se o pr√≥ximo jogador acreditar, ele segue jogando. Se duvidar, ele grita "MENTIROSO!" desafiando quem jogou a √∫ltima carta. <b>OBS:</b> Apenas o jogador seguinte pode desafiar o anterior.
                <p><b>5. O Desafio:</b> 
                    <br>- Se era <b>MENTIRA</b>: O mentiroso puxa o gatilho da pr√≥pria arma.
                    <br>- Se era <b>VERDADE</b>: O acusador puxa o gatilho da pr√≥pria arma.
                </p>
                
                <p><b>6. O Disparo:</b> O jogo simula uma roleta russa se sua arma falhar voc√™ deu sorte, mas se disparar a bala voc√™ est√° fora da partida. A cada disparo as cartas s√£o embaralhadas de novo e o jogador √† direita de quem puxou o gatilho vai iniciar. Por isso, coloque os jogadores na ordem de sele√ß√£o.</p>
                <p><b>7. Quem paga a conta:</b> Essa parte √© opcional cada jogador eliminado pode pagar uma prenda ou como est√£o em um bar...</p>
                <div style="text-align: center; margin: 15px 0; border-top: 1px dashed #555; border-bottom: 1px dashed #555; padding: 5px;">
                    <h3 style="margin: 0; color: var(--gold);">ESPECIAIS*</h3>
                </div>

                <p><b>8. Modo Massacre:</b> No modo Massacre o Valete (J) toca o terror. Se ele for jogado e algu√©m desafiar TODOS na mesa entram no duelo exceto quem jogou o Valete.</p>
                
                <p><b>9. Modo Caos:</b> Se algu√©m jogar um 8 e for desafiado, o Caos reina. Todos escolhem um alvo para atirar (exceto si mesmo). O Diabo vai influenciar, mas a decis√£o √© sua.</p>

            </div>
        </div>
        <button class="western-btn primary" onclick="App.exitRules()">VOLTAR</button>
    </div>

    <div id="screen-setup" class="screen">
        <div class="paper-panel">
            <h2 class="text-center">JOGADORES</h2>
            <p class="text-center" style="font-size: 0.9rem;">Os jogadores devem estar organizados no sentido anti-hor√°rio.</p>
            <div id="slots-container" class="mt-2"></div>

            <div style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:10px;">
                <div class="switch-container" style="margin:0;">
                    <span class="massacre-label">MASSACRE</span>
                    <label class="switch">
                        <input type="checkbox" id="massacre-toggle" checked onchange="App.toggleMassacreConfig()">
                        <span class="slider round"></span>
                    </label>
                </div>

                <div class="switch-container chaos-style" style="margin:0;">
                    <span class="massacre-label">CAOS</span>
                    <label class="switch">
                        <input type="checkbox" id="chaos-toggle" onchange="App.toggleChaosConfig()">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>

        </div>
        <button id="btn-start-match" class="western-btn primary" disabled onclick="App.confirmOrder()">INICIAR PARTIDA</button>
        <button class="western-btn danger" onclick="App.goTo('start')">VOLTAR</button>
    </div>

    <div id="screen-loading" class="screen">
        <div class="loading-container">
            <h2 class="pulsate">EMBARALHANDO</h2>
            <div class="card-animation">
                <div class="card-anim"></div>
                <div class="card-anim"></div>
                <div class="card-anim"></div>
            </div>
            <div id="deck-config-info" class="loading-deck-info"></div>
        </div>
    </div>

    <div id="screen-database" class="screen">
        <div class="paper-panel">
            <h3>Adicionar Jogador</h3>
            <div style="display:flex; gap:5px;">
                <input type="text" id="new-player-input" placeholder="Nome..." style="flex:1; padding:8px; font-family: inherit; color: #000;">
                <button class="western-btn secondary" style="width:auto; margin:0;" onclick="App.addNewPlayerDB()">+</button>
            </div>
            <hr style="border-color:#aaa; margin:15px 0;">
            <h3>Salvos:</h3>
            <div id="db-list" style="max-height:200px; overflow-y:auto;"></div>
        </div>
        <button class="western-btn danger" onclick="App.renderSetup(); App.goTo('setup')">CANCELAR</button>
    </div>

    <div id="screen-rotation" class="screen">
        <div class="text-center">
            <h2 id="rot-title" style="color: var(--gold); text-shadow: 2px 2px 0 #000;">A CARTA DA MESA √â...</h2>
            <div class="card-wrapper-padding">
                <div class="flip-container">
                    <div class="flipper" id="card-flipper">
                        <div class="front" id="rot-card-front"></div>
                        <div class="back"></div>
                    </div>
                </div>
            </div>
            <div id="rot-narrator" class="narrator-box" style="margin-top: 10px;"></div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <button class="help-btn" onclick="App.goTo('rules')">?</button>

        <div class="mesa-info">
            <div id="game-mesa-info" style="color: var(--paper); font-weight: bold; font-size: 1.2rem;">Mesa de ?</div>
        </div>
        
        <div class="card-display" id="game-mesa-card"></div>
        <div id="starter-info" style="text-align:center; margin:5px 0; color:#ccc; font-size:1.15rem;"></div>

        <div id="game-narrator-area" class="narrator-box"></div>
        
        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 5px;">
    <div id="game-status" style="min-height: 3.5em; display:flex; align-items:center; justify-content:center;"></div>
    
    <div style="display:flex; flex-direction: column; gap: 6px; margin-left: 8px;">
        <button id="btn-chaos-toggle" class="btn-purple" onclick="App.toggleChaosMode()" style="margin:0;">üåÄ</button>
        <button id="btn-duel-toggle" class="btn-black" onclick="App.toggleDuelMode()" style="margin:0;">‚öîÔ∏è</button>
    </div>
</div>

        <div id="game-players-list"></div>

        <div id="game-log" class="log-box"></div>

        <div style="display:flex; gap:5px; margin-top:10px;">
            <button class="western-btn secondary" onclick="App.restartGame()">REINICIAR</button>
            <button class="western-btn danger" onclick="App.goTo('setup')">SAIR</button>
        </div>
    </div>

    <div id="screen-win" class="screen">
        <div class="paper-panel text-center" style="border-color: var(--gold);">
            <h1 style="color: #d4af37;">VENCEDOR!</h1>
            <p id="win-msg" style="font-size: 1.2rem; font-weight: bold;"></p>
            <div id="win-achievements" style="margin-top: 15px; border-top: 1px dashed #000; padding-top: 10px;"></div>
        </div>
        <button class="western-btn primary" onclick="App.restartGame()">JOGAR NOVAMENTE</button>
        <button class="western-btn secondary" onclick="App.goTo('setup')">MUDAR JOGADORES</button>
    </div>

    <div id="screen-stats" class="screen">
        <h2 class="text-center" style="color: var(--paper);">LIVRO DE REGISTROS</h2>
        <div class="chalkboard" id="stats-board" style="max-height:400px; overflow-y:auto;"></div>
        <div class="mt-2">
            <button class="western-btn danger" onclick="App.confirmResetStats()">APAGAR TUDO</button>
            <button class="western-btn primary" onclick="App.goTo('start')">VOLTAR</button>
        </div>
    </div>

    <div id="screen-achievements" class="screen">
        <div class="paper-panel">
            <h3 id="ach-screen-title" class="text-center">Conquistas de Fulano</h3>
            <div id="ach-list-content" class="scroll-content"></div>
        </div>
        <button class="western-btn primary" onclick="App.goTo('stats')">VOLTAR √ÄS ESTAT√çSTICAS</button>
    </div>
</div>

<script type="module">
/* --- CONFIG e NARRADORES --- */
const CONFIG = {
    paths: {
        img: 'src/assets/imgs/',
        snd: 'src/assets/sounds/' 
    },
    fallbackSnd: 'src/assest/sounds/', 
    cards: { K: "king-hearts.png", Q: "queen-diamonds.png", A: "ace-spades.png", 8: "card-back.png" },
    sounds: { intro: 'six-shots-left.mp3', rotation: 'rotation-suspense.mp3', cock: 'cocking-a-revolver.mp3', shot: 'gun-shot.mp3', empty: 'empty-gun.mp3' },
    emojis: { 
        Marrento: "üòé", Covarde: "ü´£", Piadista: "üòú", Entediado: "üôÑ", 
        Nordestino: "üò†", Esfomeado: "üòã", Sabio: "üßô‚Äç‚ôÇÔ∏è", Morte: "üíÄ",
        Diabo: "üòà"
    },
    deathLines: [
        "Ainda n√£o.", "Hoje n√£o.", "N√£o dessa vez.", "Ficou pra depois.", "Por pouco, hein.",
        "Passou batido.", "Quase.", "Outra hora talvez.", "N√£o agora.", "Escapou."
    ],
    // PERFIS ATUALIZADOS COM O CONTE√öDO ANTIGO + MAIS RICO
    perfis: {
        Marrento: {
            before: [
                "Vamos ver se a sorte est√° do meu lado.",
                "Eu n√£o erro, no m√°ximo a realidade me desobedece.",
                "Confia que o pai t√° on.",
                "Se a morte quer me levar, vai ter que ser na marra."
            ],
            afterSurvive: [
                "T√° vendo? At√© a morte me respeita.",
                "Eu sou t√£o brabo que at√© o perigo desiste.",
                "Se era pra me assustar, precisa tentar mais forte.",
                "Eu n√£o sobrevivo: eu humilho o perigo."
            ]
        },
        Covarde: {
            before: [
                "Algu√©m quer ir no meu lugar?",
                "Eu com um mal pressentimento sobre isso.",
                "Se der ruim, n√£o fala pra minha m√£e que eu me mijei‚Ä¶ de novo.",
                "S√≥ quero sair daqui inteiro, por favor."
            ],
            afterSurvive: [
                "Meu cora√ß√£o t√° tipo: Se voc√™ n√£o parar eu paro.",
                "Caramba, meu cora√ß√£o bateu at√© errado.",
                "Acho que minha alma ficou pelo caminho.",
                "Sobrevivi, mas acho que vou precisar de terapia."
            ]
        },
        Piadista: {
            before: [
                "Se eu morrer, pelo menos n√£o pago a conta.",
                "J√° sobrevivi a grupo de fam√≠lia, isso aqui √© fichinha.",
                "Essa arma aqui j√° viu mais mentira que WhatsApp em √©poca de elei√ß√£o.",
                "Relaxa, eu sou personagem principal, teoricamente n√£o morro agora.",
                "Algu√©m avisa o roteirista que eu t√¥ pronto pra pr√≥xima cena?",
                "Se isso der errado, j√° deixei meu curr√≠culo no c√©u."
            ],
            afterSurvive: [
                "Podem respirar, o al√≠vio c√¥mico ainda t√° vivo.",
                "Voc√™s esperavam o qu√™? Protagonista morrendo no meio do filme?",
                "Podem aplaudir, mas sem exagero, t√¥ acostumado.",
                "Sobrevivi de novo, t√¥ quase virando s√©rie regular.",
                "Ufa! J√° pensou perder o personagem mais engra√ßado?"
            ]
        },
        Entediado: {
            before: [
                "J√° vivi coisa pior‚Ä¶ tipo segunda-feira.",
                "A vida √© uma fila: eu s√≥ t√¥ esperando minha vez.",
                "√â s√≥ mais um cap√≠tulo, com ou sem continua√ß√£o.",
                "Se eu cair, me acordem quando acabar.",
                "Se eu morrer agora, pelo menos n√£o pego tr√¢nsito na volta."
            ],
            afterSurvive: [
                "Pelo visto n√£o era minha vez ainda.",
                "Ok, continuei vivo. Que t√©dio!",
                "Olha s√≥‚Ä¶ estou tentando me matar voc√™s erram."
            ]
        },
        Nordestino: {
            before: [
                "Se for hoje, que seja ligeiro. Num tenho tempo pra frescura.",
                "Bora, desgra√ßa! Ou vai ou racha, porra!.",
                "Eu t√¥ virado no m√≥i de coentro.",
                "Vamo simbora, que hoje tem risca faca."
            ],
            afterSurvive: [
                "Rapadura √© doce, mas n√© mole n√£o.",
                "T√° pensando que bei√ßo de jegue √© arroz doce.",
                "Sobrevivi? Eita porra‚Ä¶ agora sim o bicho vai pegar.",
                "Oxe, essa foi por um triz!",
                "A bala olhou e disse: Seloko num compensa"
            ]
        },
        Esfomeado: {
            before: [
                "Eu t√¥ tremendo, mas √© de fome mesmo.",
                "Se eu n√£o morrer t√° me devendo uma tapioca.",
                "Se der certo, me tragam cuscuz. Se der errado‚Ä¶ enterra com farinha.",
                "Se der ruim fala pro meu nutri que eu n√£o vou precisar mais dele."
            ],
            afterSurvive: [
                "Sobrevivi, miser√°veis. Agora quero meu pastel com caldo de cana.",
                "T√¥ vivo, fala que n√£o preciso mais de nutri.",
                "Se a bala tivesse gosto de bacon, talvez eu at√© encarava ela.",
                "Deu bom, agora vamos comer e morar"
            ]
        }
    },
    diabo: {
        intro: "Isso est√° ficando interessante.",
        taunts: [
            "üëø Fulano t√° rindo demais‚Ä¶ acaba com essa alegria dele.",
            "üëø Se eu fosse voc√™, eu atirava no fulano.",
            "üëø Fulano t√° muito quieto‚Ä¶ sempre desconfie dos quietos.",
            "üëø Ouvi fulano dizendo que voc√™ n√£o tem coragem, vai deixar?",
            "üëø Fulano t√° confiante demais. Acaba logo com isso.",
            "üëø Mira no fulano para eu ver o que acontece.",
            "üëø Fulano xingou sua m√£e, eu n√£o deixava.",
            "üëø Fulano disse que ia atirar em voc√™.",
            "üëø Fulano t√° tirando onda com sua cara. Vai ficar s√≥ olhando?",
            "üëø Fulano lhe chamou de frouxo ali na mesa‚Ä¶ eu mesmo ouvi."
        ],
        outro: "üòà √â assim que eu gosto MuahahaHAHAHA...",
        results: {
            none: ["üëø Que palha√ßada foi essa? Esse jogo √© rid√≠culo.", "üëø T√° de brincadeira! Ningu√©m?"],
            one: ["üòà Eu tenho tantos planos para voc√™..."],
            many: ["üòà Eu adoro esse jogo hahahaha"]
        }
    },
    // NARRADORES ATUALIZADOS COM O CONTE√öDO ANTIGO + MESA DE 8 DO NOVO
    narradores: {
        Sabio: {
            intro: "üßô‚Äç‚ôÇÔ∏è Lembrem-se que em cada mentira h√° risco, e em cada risco pode faltar um gole no pr√≥ximo drink.",
            mesaIntro: {
                K: "Mesa de Rei: o poder √© fachada, as balas n√£o se curvam a coroas.",
                Q: "Mesa de Rainha: subestimar a realeza sempre cobra seu pre√ßo.",
                A: "Mesa de √Ås: o momento em que sorte e imprud√™ncia se confundem."
            },
            killLines: {
                Esfomeado: "At√© a fome cobra a conta uma hora.",
                Marrento: "A arrog√¢ncia sempre encontra o pr√≥prio fim.",
                Covarde: "Fugir do risco n√£o adiou o inevit√°vel, s√≥ deixou mais doloroso.",
                default: "Mais uma li√ß√£o escrita em chumbo para quem quiser aprender."
            },
            winner: [
                "{nome}, mentiu melhor do que todos, mas lembre-se: at√© a sorte cansa.",
                "Hoje o t√≠tulo √© seu, {nome}. S√≥ n√£o esque√ßa que toda vit√≥ria tem um pre√ßo."
            ]
        },
        Piadista: {
            intro: "ü§≠ N√£o vale dedo no olho nem nas partes baixas‚Ä¶ voc√™s sabem bem por qu√™.",
            mesaIntro: {
                K: "Mesa de Rei: Respeita a autoridade.",
                Q: "Mesa de Rainha: Cuidado! Ela √© mais perigosa que a arma.",
                A: "Mesa de √Ås: Modo hard ativado, meus consagrados."
            },
            killLines: {
                Piadista: "Eita! O estressadinho levou um sossega le√£o.",
                Nordestino: "Pelo menos agora ele n√£o t√° gritando com ningu√©m.",
                Marrento: "Agora o jogo t√° uma bosta, a pessoa mais sexy foi embora.",
                default: "Parem de cair assim, t√¥ ficando sem piada nova."
            },
            winner: [
                "{nome}, parab√©ns, mentiu t√£o bem que at√© eu quase acreditei.",
                "A mesa aplaude, {nome}. Ah n√£o, √© s√≥ o gelo batendo no copo mesmo."
            ]
        },
        Entediado: {
            intro: "üòí Se algu√©m morrer, me avisem. Posso n√£o estar prestando aten√ß√£o.",
            mesaIntro: {
                K: "Mesa de Rei. Grande coisa.",
                Q: "Mesa de Rainha. Tentem n√£o passar tanta vergonha.",
                A: "Mesa de √Ås. Pelo menos muda o desenho."
            },
            killLines: {
                Piadista: "At√© que enfim calou a boca.",
                Esfomeado: "No c√©u tem p√£o? E morreu... Pr√≥ximo.",
                Entediado: "Pelo menos agora ele n√£o precisa fingir interesse.",
                default: "Mais um que caiu. Nada novo."
            },
            winner: [
                "Parab√©ns, {nome}. Voc√™ venceu. Agora posso ir embora?",
                "{nome} ganhou. Se algu√©m se importar, finge que comemora."
            ]
        },
        Covarde: {
            intro: "üò® Galera, s√≥ lembrando... Aponta essa arma pra longe de mim, por favor.",
            mesaIntro: {
                K: "Mesa de Rei: Se comportem.",
                Q: "Mesa de Rainha: Tentem pelo menos n√£o fazer nada idiota‚Ä¶ √© dif√≠cil, eu sei.",
                A: "Mesa de √Ås: algu√©m segura minha m√£o? Por seguran√ßa psicol√≥gica."
            },
            killLines: {
                Covarde: "Eu sabia! Eu devia ter ido embora!",
                Nordestino: "Ser√° que ele morreu mesmo? Ainda t√° com cara de bravo.",
                Entediado: "Ele caiu t√£o devagar que eu achei que tava s√≥ alongando!",
                default: "Cuidado! Ele quase me acertou."
            },
            winner: [
                "Vit√≥ria do {nome}! √ìtimo‚Ä¶ agora que tal jogo da velha? √â mais seguro.",
                "Parab√©ns do {nome}‚Ä¶ agora vamos embora antes que algu√©m tente outra rodada."
            ]
        }
    }
};

const ACHIEVEMENTS_DEF = [
    // --- VIS√çVEIS ---
    { id: 'first_win', emoji: 'üèÜ', name: 'Nasce uma Lenda', desc: 'Venceu a partida pela primeira vez.', check: (s, c) => s.wins === 1 },
    { id: 'vip_client', emoji: 'ü§†', name: 'Cliente VIP', desc: 'Jogou 20 partidas completas.', check: (s, c) => s.matches >= 20 },
    { id: 'win_10', emoji: 'üíÄ', name: 'O Terror da Mesa', desc: 'Ganhou 10 partidas.', check: (s, c) => s.wins >= 10 },
    { id: 'die_10', emoji: 'ü§ï', name: 'Alvo F√°cil', desc: 'Morreu 10 vezes.', check: (s, c) => s.hits >= 10 },
    { id: 'die_5_6', emoji: 'üò®', name: '√öltimo Suspiro', desc: 'Ficou faltando s√≥ um disparo (5/6).', check: (s, c) => c.didDodgeLastShotBefore },
    { id: 'massacre_3_deaths', emoji: 'ü©∏', name: 'Banho de Sangue', desc: '3 ou mais morreram num massacre.', check: (s, c) => c.isMassacre && c.massacreDeaths >= 3 },
    { id: 'chaos_luck', emoji: 'üçÄ', name: 'Sorte no Caos', desc: 'Faltando dois disparos para morrer acertou outro jogador.', check: (s, c) => c.chaosLuckHit },

    // --- OCULTAS ---
    { id: 'die_1_6', emoji: '‚è±Ô∏è', name: 'Speedrun do Al√©m', desc: 'Morreu no primeiro disparo.', isHidden: true, check: (s, c) => c.diedOnShot === 1 },
    { id: 'cat_lives', emoji: 'üêà', name: 'Sete Vidas', desc: 'Acumulou 70 sobreviv√™ncias.', isHidden: true, check: (s, c) => s.dodges >= 70 },
    { id: 'win_last_shot', emoji: 'üòé', name: 'Um p√© na cova', desc: 'Venceu por um triz (5/6).', isHidden: true, check: (s, c) => c.didWinLastShotBefore && s.wins >= 1 },
    { id: 'win_streak_3', emoji: 'üî•', name: 'Imorr√≠vel', desc: 'Ganhou 3 partidas seguidas.', isHidden: true, check: (s, c) => s._meta.winStreak >= 3 },
    { id: 'no_shot_win', emoji: 'ü§ñ', name: 'T√° de Hack', desc: 'Venceu sem disparar (0/6).', isHidden: true, check: (s, c) => s.wins >= 1 && s.dodges === 0 && s.hits === 0 },
    { id: 'untouchable', emoji: '‚öñÔ∏è', name: 'O Intoc√°vel', desc: 'Ganhou tendo sido protegido na rodada final.', isHidden: true, check: (s, c) => c.wasProtectedWinner },
    { id: 'king_table', emoji: 'üëë', name: 'Rei da Mesa', desc: 'Ganhou 20 ou mais partidas.', isHidden: true, check: (s, c) => s.wins >= 20 },
    { id: 'legend_legends', emoji: 'üßô‚Äç‚ôÇÔ∏è', name: 'Lenda das Lendas', desc: 'Ganhou 50 ou mais partidas.', isHidden: true, check: (s, c) => s.wins >= 50 },
    { id: 'dreaming_beyond', emoji: 'üò≠', name: 'Est√£o Deixando a Gente Sonhar... No Al√©m', desc: 'Primeiro a morrer tr√™s vezes seguidas.', isHidden: true, check: (s, c) => s._meta.dieStreak >= 3 },
    { id: 'die_stubborn', emoji: '‚ò†Ô∏è', name: 'Morreu de Teimoso', desc: 'Morreu na √∫ltima bala (6/6).', isHidden: true, check: (s, c) => c.diedOnShot === 6 },
    { id: 'die_50', emoji: 'üò≠', name: 'N√£o estou suportando mais', desc: 'Morreu 50 ou mais vezes.', isHidden: true, check: (s, c) => s.hits >= 50 },
    { id: 'die_100', emoji: 'ü™¶', name: 'Veterano do Al√©m', desc: 'Morreu 100 ou mais vezes.', isHidden: true, check: (s, c) => s.hits >= 100 },
    { id: 'saint_intern', emoji: 'üòá', name: 'O Santo era Estagi√°rio', desc: 'Morreu na segunda bala (2/6).', isHidden: true, check: (s, c) => c.diedOnShot === 2 },
    { id: 'public_enemy', emoji: 'üéØ', name: 'Inimigo P√∫blico n¬∫ 1', desc: 'Sobreviveu ao Caos sendo alvo de 3 ou mais jogadores.', isHidden: true, check: (s, c) => c.publicEnemySurvived },
    { id: 'devil_listener', emoji: 'üòà', name: 'Deu ouvido ao mau', desc: 'Atirou em quem o Diabo mandou.', isHidden: true, check: (s, c) => c.listenedToDevil },
    { id: 'hope_last', emoji: 'üìâ', name: 'A Esperan√ßa √© a √∫ltima que morre... Voc√™ n√£o.', desc: 'Sobreviveu ao caos na 5/6, mas morreu logo em seguida.', isHidden: true, check: (s, c) => c.hopeLastDies },
    { id: 'zombie_bar', emoji: 'üßü', name: 'Zumbi do Bar', desc: 'Jogou 50 ou mais, mas ganhou menos de 5.', isHidden: true, check: (s, c) => s.matches >= 50 && s.wins < 5 },
    { id: 'me_and_you', emoji: 'üíû', name: 'Agora sou eu e voc√™ meu gostoso!', desc: 'Quando os dois se miram e morrem.', isHidden: true, check: (s, c) => c.mutualChaosDeath }
];

/* --- AUDIO --- */
const AudioSys = {
    cache: {}, bgm: null, initialized: false,
    init() {
        if (this.initialized) return;
        Object.keys(CONFIG.sounds).forEach(key => {
            const audio = new Audio(); audio.preload = 'auto';
            audio.src = CONFIG.paths.snd + CONFIG.sounds[key];
            this.cache[key] = audio;
            this.cache[key].__fallback = CONFIG.fallbackSnd + CONFIG.sounds[key];
        });
        this.initialized = true;
    },
    play(key, loop = false) {
        this.init();
        const base = this.cache[key];
        if (!base) return;
        const audio = new Audio();
        audio.loop = loop; audio.preload = 'auto'; audio.volume = 0.9; audio.src = base.src;
        audio.play().catch(() => { if (base.__fallback) { audio.src = base.__fallback; audio.play().catch(() => {}); } });
        try { audio.currentTime = 0; } catch (e) {}
        return audio;
    },
    playLoop(key) { this.stopLoop(); this.bgm = this.play(key, true); },
    stopLoop() { if (this.bgm) { try { this.bgm.pause(); } catch (e) {} this.bgm = null; } }
};

/* --- STORAGE & STATE --- */
const Storage = {
    get(key, def) { try { return JSON.parse(localStorage.getItem('mentiroso_' + key)) || def; } catch { return def; } },
    set(key, val) { localStorage.setItem('mentiroso_' + key, JSON.stringify(val)); }
};

let STATE = {
    slots: Storage.get('slots', Array(6).fill(null)),
    db: Storage.get('db', []),
    stats: Storage.get('stats', {}),
    achieved: Storage.get('achieved', {}),
    game: { 
        active: false, players: [], turnIndex: 0, mesaCard: 'A', mesaShots: 0, 
        narrator: null, isShooting: false, isMassacre: false, protectedIdx: null, 
        lastProtectedIdx: null, roundUnlocks: [], deathLinesDeck: [], deathLineIdx: 0, massacreMode: true, chaosMode: false,
        chaos: { active: false, queue: [], currentPickIdx: 0, targets: {}, votes: {}, devilTarget: null }
    }
};

/* --- L√ìGICA --- */
const Logic = {
    getNarrator() {
        const keys = Object.keys(CONFIG.narradores);
        return keys[Math.floor(Math.random() * keys.length)];
    },
    createPlayer(name, perfilFixo) {
        return { name, perfil: perfilFixo, alive: true, shotsTaken: 0, gun: { chamber: 0, bullet: Math.floor(Math.random() * 6) }, lines: { before: 0, afterSurvive: 0 } };
    },
    rotateTable(forceNext = false) {
    const order = ['K','Q','A']; 
    if (forceNext || STATE.game.mesaShots >= 3) {
        let idx = order.indexOf(STATE.game.mesaCard);
        if(idx === -1) idx = 0;
        STATE.game.mesaCard = order[(idx + 1) % order.length];
        STATE.game.mesaShots = 0;
        return true;
    }
    return false;
},
    shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    },
    checkAchievements(pName, events, notify = true) {
        if (!pName) return;
        if (!STATE.stats[pName]) STATE.stats[pName] = { wins:0, hits:0, dodges:0, matches: 0, _meta: {} };
        const stats = STATE.stats[pName];
        if (!STATE.achieved[pName]) STATE.achieved[pName] = [];
        ACHIEVEMENTS_DEF.forEach(ach => {
            if (!STATE.achieved[pName].includes(ach.id)) {
                if (ach.check(stats, events)) {
                    STATE.achieved[pName].push(ach.id);
                    if (notify) View.showToast(pName, ach);
                    else STATE.game.roundUnlocks.push(ach.id);
                }
            }
        });
        Storage.set('stats', STATE.stats);
        Storage.set('achieved', STATE.achieved);
    }
};

/* --- APP CONTROLLER --- */
const App = {
    currentSlot: null,
    duelMode: false, 

    init() {
        this.renderSetup();
        if (STATE.slots.filter(Boolean).length === 0) STATE.slots = [null,null,null,null,null,null];
        
        // Verifica primeiro acesso
        if (!localStorage.getItem('mentiroso_visited')) {
            View.showModal("BEM-VINDO!", "Como √© sua primeira vez, recomendamos ler as regras antes de come√ßar.", [
                { text: "LER REGRAS", class: "primary", action: () => { View.closeModal(); App.goTo('rules'); localStorage.setItem('mentiroso_visited', 'true'); } },
                { text: "J√Å SEI JOGAR", class: "secondary", action: () => { View.closeModal(); localStorage.setItem('mentiroso_visited', 'true'); } }
            ]);
        }
    },
    goTo(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-' + screenId).classList.add('active');
        if (screenId === 'stats') this.renderStats();
    },
    exitRules() {
        if (STATE.game.active) this.goTo('game');
        else this.goTo('start');
    },
    toggleMassacreConfig() {
        const sw = document.getElementById('massacre-toggle');
        const chaosSw = document.getElementById('chaos-toggle');
        const count = STATE.slots.filter(Boolean).length;

        if (count >= 6) {
            // Regra 1: Pelo menos um deve estar ligado.
            if (!sw.checked && !chaosSw.checked) {
                chaosSw.checked = true; // Se desligou massacre e caos estava off, liga caos
                STATE.game.chaosMode = true;
            }
        } else if (count <= 4) {
            // Regra 2: Exclusivo.
            if (sw.checked && chaosSw.checked) {
                chaosSw.checked = false; // Se ligou massacre, desliga caos
                STATE.game.chaosMode = false;
            }
        }

        STATE.game.massacreMode = sw.checked;
        this.renderSetup(); // Re-render para atualizar visual
        
        if (sw.checked) {
            const t = document.getElementById('systemToast');
            t.textContent = "O Valete entrou na festa. Dancem üî•";
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 1500);
        }
    },
    // Nova fun√ß√£o: Controle do Modo Caos
    toggleChaosConfig() {
        const sw = document.getElementById('chaos-toggle');
        const massSw = document.getElementById('massacre-toggle');
        const count = STATE.slots.filter(Boolean).length;

        if (count >= 6) {
            // Regra 1: Pelo menos um deve estar ligado.
            if (!sw.checked && !massSw.checked) {
                massSw.checked = true; // Se desligou caos e massacre estava off, liga massacre
                STATE.game.massacreMode = true;
            }
        } else if (count <= 4) {
            // Regra 2: Exclusivo.
            if (sw.checked && massSw.checked) {
                massSw.checked = false; // Se ligou caos, desliga massacre
                STATE.game.massacreMode = false;
            }
        }

        STATE.game.chaosMode = sw.checked;
        this.renderSetup(); // Re-render para atualizar visual
        
        if (sw.checked) {
            const t = document.getElementById('systemToast');
            t.textContent = "O Caos est√° liberado üòà";
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 1500);
        }
    },
    renderSetup() {
        const container = document.getElementById('slots-container');
        container.innerHTML = '';
        const filled = STATE.slots.filter(Boolean).length;
        
        const massacreSwitch = document.getElementById('massacre-toggle');
        const chaosSwitch = document.getElementById('chaos-toggle');
        
        // Atualiza estado visual base
        massacreSwitch.checked = STATE.game.massacreMode;
        chaosSwitch.checked = STATE.game.chaosMode;

        // Se por acaso entrar num estado inv√°lido inicial, corrige silenciosamente
        if (filled >= 6 && !STATE.game.massacreMode && !STATE.game.chaosMode) {
            STATE.game.massacreMode = true; massacreSwitch.checked = true;
        }

        const slotsToShow = Math.min(6, Math.max(2, filled + 1));
        for (let i=0;i<slotsToShow;i++) {
            const name = STATE.slots[i];
            const div = document.createElement('div');
            div.className = 'slot-row';
            if (!name) {
                div.innerHTML = `<span class="slot-name" style="opacity:0.5; font-style:italic">Vazio...</span>
                                 <button class="western-btn secondary small" onclick="App.openSelect(${i})">Selecionar</button>`;
            } else {
                div.innerHTML = `<span class="slot-name">${name}</span>
                                 <div style="display:flex; gap:4px;">
                                     <button class="tiny-btn bg-blue" onclick="App.moveSlot(${i}, -1)" style="${i === 0 ? 'visibility:hidden' : ''}">‚ñ≤</button>
                                     <button class="tiny-btn bg-blue" onclick="App.moveSlot(${i}, 1)" style="${i >= filled-1 ? 'visibility:hidden' : ''}">‚ñº</button>
                                     <button class="tiny-btn bg-red" onclick="App.clearSlot(${i})">X</button>
                                 </div>`;
            }
            container.appendChild(div);
        }
        document.getElementById('btn-start-match').disabled = filled < 2;
        Storage.set('slots', STATE.slots);
    },
    moveSlot(idx, dir) {
        const tmp = STATE.slots[idx];
        STATE.slots[idx] = STATE.slots[idx+dir]; STATE.slots[idx+dir] = tmp;
        const compact = STATE.slots.filter(Boolean);
        STATE.slots = compact.concat(Array(6-compact.length).fill(null));
        this.renderSetup();
    },
    clearSlot(idx) {
        STATE.slots[idx] = null;
        const compact = STATE.slots.filter(Boolean);
        STATE.slots = compact.concat(Array(6-compact.length).fill(null));
        this.renderSetup();
    },
    renderDBList() {
        const dbList = document.getElementById('db-list'); dbList.innerHTML = '';
        const used = STATE.slots.filter(Boolean);
        const avail = STATE.db.filter(n => !used.includes(n));
        
        if (avail.length === 0) dbList.innerHTML = '<p style="text-align:center; opacity:0.6">Nenhum salvo.</p>';
        
        avail.forEach(pName => {
            const row = document.createElement('div'); row.className = 'db-row';
            const nameBtn = document.createElement('button'); nameBtn.className = 'db-name-btn';
            nameBtn.textContent = pName;
            nameBtn.onclick = () => { STATE.slots[this.currentSlot] = pName; this.goTo('setup'); this.renderSetup(); };
            
            const delBtn = document.createElement('button'); delBtn.className = 'db-remove-btn'; delBtn.textContent = 'EXPULSAR';
            delBtn.onclick = () => this.confirmDeletePlayer(pName);
            
            row.appendChild(nameBtn); row.appendChild(delBtn); dbList.appendChild(row);
        });
    },
    openSelect(idx) {
        this.currentSlot = idx;
        this.renderDBList();
        this.goTo('database');
    },
    addNewPlayerDB() {
        const input = document.getElementById('new-player-input');
        const val = input.value.trim();
        if (STATE.slots.includes(val)) {
            View.showModal("J√Å EST√Å NA MESA!", `O jogador "${val}" j√° foi selecionado.`, [ { text: "Ops, foi mal", class: "primary", action: () => View.closeModal() } ]);
            return;
        }
        if (val && !STATE.db.includes(val)) {
            STATE.db.push(val); Storage.set('db', STATE.db); input.value = '';
            
            // Seleciona direto e volta
            STATE.slots[this.currentSlot] = val;
            this.goTo('setup');
            this.renderSetup();
        }
    },
    confirmOrder() {
        const players = STATE.slots.filter(Boolean);
        if (players.length === 2) this.showLoading();
        else {
            View.showModal("A ORDEM EST√Å CORRETA?", "Sentido anti-hor√°rio √© para a direita üòí", [
                { text: "SIM, BORA!", class: "primary", action: () => this.showLoading() },
                { text: "N√ÉO, PERA", class: "secondary", action: () => View.closeModal() }
            ]);
        }
    },
    showLoading() {
        View.closeModal(); this.goTo('loading');
        const count = STATE.slots.filter(Boolean).length;
        const isM = STATE.game.massacreMode;
        const isC = STATE.game.chaosMode;
        let info = "";

        // At√© 4 Jogadores (20 cartas) - Modos s√£o exclusivos aqui
        if (count <= 4) {
            const base = "<b>6</b> Reis, <b>6</b> Damas, <b>6</b> Ases";
            if (isM) info = `${base}, <b>1</b> Coringa e <b>1</b> Valete.`;
            else if (isC) info = `${base}, <b>1</b> Coringa e <b>1</b> Carta 8.`;
            else info = `${base} e <b>2</b> Coringas.`;
        } 
        // 5 Jogadores (25 cartas)
        else if (count === 5) {
            const base = "<b>7</b> Reis, <b>7</b> Damas, <b>7</b> Ases";
            if (isM && isC) info = `${base}, <b>1</b> Coringa, <b>1</b> Valete e <b>1</b> Carta 8.`;
            else if (isM) info = `${base}, <b>2</b> Coringas e <b>1</b> Valete.`;
            else if (isC) info = `${base}, <b>2</b> Coringas e <b>1</b> Carta 8.`;
            else info = `${base} e <b>3</b> Coringas.`;
        } 
        // 6 Jogadores (30 cartas)
        else {
            const base = "<b>8</b> Reis, <b>8</b> Damas, <b>8</b> Ases";
            if (isM && isC) info = `${base}, <b>2</b> Coringas, <b>1</b> Valete e <b>1</b> Carta 8.`;
            else if (isM) info = `${base}, <b>2</b> Coringas e <b>2</b> Valetes.`;
            else if (isC) info = `${base}, <b>2</b> Coringas e <b>2</b> Cartas 8.`;
            else info = `${base} e <b>4</b> Coringas.`;
        }

        document.getElementById('deck-config-info').innerHTML = info;
        setTimeout(() => { this.startIntro(); }, 4000);
    },
    startIntro() {
        const playersNames = STATE.slots.filter(Boolean);
        STATE.game.active = true; STATE.game.isShooting = false; STATE.game.isMassacre = false;
        STATE.game.protectedIdx = null; STATE.game.lastProtectedIdx = null; STATE.game.roundUnlocks = [];
        STATE.game.chaos = { active: false, queue: [], currentPickIdx: 0, targets: {}, votes: {}, devilTarget: null };

        const perfisDisponiveis = Object.keys(CONFIG.perfis);
        for (let i = perfisDisponiveis.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [perfisDisponiveis[i], perfisDisponiveis[j]] = [perfisDisponiveis[j], perfisDisponiveis[i]];
        }
        STATE.game.players = playersNames.map((name, idx) => Logic.createPlayer(name, perfisDisponiveis[idx % perfisDisponiveis.length]));
        STATE.game.turnIndex = Math.floor(Math.random() * playersNames.length);
        STATE.game.narrator = Logic.getNarrator();
        STATE.game.mesaCard = ['K','Q','A'][Math.floor(Math.random()*3)];
        STATE.game.mesaShots = 0;
        
        STATE.game.deathLinesDeck = [...CONFIG.deathLines];
        Logic.shuffle(STATE.game.deathLinesDeck);
        STATE.game.deathLineIdx = 0;
        this.runRotationAnim(true);
    },
    runRotationAnim(isIntro = false) {
        this.goTo('rotation');
        // Ajuste Solicitado: Tocar musica intro somente na intro
        if (isIntro) {
            AudioSys.play('intro'); 
        } else {
            AudioSys.play('rotation'); 
        }
        
        const cardFace = document.getElementById('rot-card-front');
        const imgName = CONFIG.cards[STATE.game.mesaCard] || 'card-back.png';
        cardFace.style.backgroundImage = `url('${CONFIG.paths.img}${imgName}')`;
        const narratorElm = document.getElementById('rot-narrator');
        if (isIntro) {
            narratorElm.textContent = CONFIG.narradores[STATE.game.narrator].intro;
            document.getElementById('rot-title').textContent = "A CARTA DA MESA √â...";
        } else {
            const mesaLine = (CONFIG.narradores[STATE.game.narrator].mesaIntro || {})[STATE.game.mesaCard] || '';
            const narrEmoji = CONFIG.emojis[STATE.game.narrator] || 'üíÄ';
            narratorElm.textContent = `${narrEmoji} ${mesaLine}`;
        }
        const flipper = document.getElementById('card-flipper');
        flipper.classList.remove('flip-anim'); void flipper.offsetWidth; flipper.classList.add('flip-anim');
        setTimeout(() => { flipper.style.transform = 'rotateY(540deg)'; this.startGameScreen(); }, 6000);
    },
    startGameScreen() {
        STATE.game.isShooting = false; STATE.game.isMassacre = false; this.duelMode = false;
        STATE.game.chaos.active = false;
        this.goTo('game'); this.updateGameUI();
        const logBox = document.getElementById('game-log'); logBox.innerHTML = '';
        const narr = CONFIG.narradores[STATE.game.narrator];
        const narrEmoji = CONFIG.emojis[STATE.game.narrator] || 'üíÄ';
        const mesaLine = (narr.mesaIntro || {})[STATE.game.mesaCard] || '';
        const pName = STATE.game.players[STATE.game.turnIndex].name;
        this.log(narr.intro);
        this.log(`${narrEmoji} ${mesaLine}`);
        this.log(`üé≤ ${pName} come√ßa essa baga√ßa!`);
    },
    toggleDuelMode() {
        if (STATE.game.isShooting || STATE.game.chaos.active) return;
        this.duelMode = !this.duelMode;
        this.renderPlayersList();
    },

    /* --- L√ìGICA DO MODO CAOS --- */
    toggleChaosMode() {
        if (STATE.game.isShooting || STATE.game.chaos.active) return;
        
        STATE.game.chaos.active = true;
        STATE.game.isShooting = true; // Bloqueia outras a√ß√µes
        this.duelMode = false;

        // Resetar estruturas
        STATE.game.chaos.targets = {};
        STATE.game.chaos.votes = {};
        STATE.game.chaos.devilTarget = null;
        
        // Fila de atiradores: come√ßa pelo turnIndex, depois roda a mesa
        const players = STATE.game.players;
        let queue = [];
        let startIdx = STATE.game.turnIndex;
        // Preenche a fila na ordem correta
        for (let i = 0; i < players.length; i++) {
            let idx = (startIdx + i) % players.length;
            if (players[idx].alive) queue.push(idx);
        }
        STATE.game.chaos.queue = queue;
        STATE.game.chaos.currentPickIdx = 0; // index na queue

        this.renderPlayersList();
        
        // Diabo fala com delay
        const devilMsg = `üòà ${CONFIG.diabo.intro}`;
        document.getElementById('game-status').textContent = devilMsg;
        this.log(devilMsg);

        setTimeout(() => {
            this.nextChaosPicker();
        }, 2000);
    },
    
    nextChaosPicker() {
        const queue = STATE.game.chaos.queue;
        const currentQueueIdx = STATE.game.chaos.currentPickIdx;

        if (currentQueueIdx >= queue.length) {
            // Todos escolheram
            this.resolveChaos();
            return;
        }

        const pickerIdx = queue[currentQueueIdx];
        const pickerName = STATE.game.players[pickerIdx].name;

        // Atualiza Texto de topo
        document.getElementById('starter-info').innerHTML = `<span style="color:var(--chaos-light); text-shadow:0 0 5px var(--chaos)">‚òÖ <b>${pickerName}</b> escolha algu√©m para testar a sorte</span>`;
        
        // Sorteio 1: Escolhe o alvo da provoca√ß√£o (diferente do picker)
        const targets = STATE.game.players.filter((p, i) => p.alive && i !== pickerIdx);
        const randomTarget = targets[Math.floor(Math.random() * targets.length)];
        
        // Guarda quem o diabo mirou para as conquistas
        STATE.game.chaos.devilTarget = randomTarget ? STATE.game.players.indexOf(randomTarget) : null;

        // Sorteio 2: Escolhe a frase do diabo
        const taunts = CONFIG.diabo.taunts;
        let taunt = taunts[Math.floor(Math.random() * taunts.length)];
        
        // Substitui o nome
        taunt = taunt.replace(/fulano/gi, randomTarget ? randomTarget.name : 'algu√©m');
        
        document.getElementById('game-status').textContent = taunt;

        this.renderPlayersList();
    },

    handleChaosPick(targetIdx) {
        const queue = STATE.game.chaos.queue;
        const pickerRealIdx = queue[STATE.game.chaos.currentPickIdx];
        
        // Salva o voto
        STATE.game.chaos.targets[pickerRealIdx] = targetIdx;
        
        // Incrementa contagem de votos no alvo para mudar emoji
        STATE.game.chaos.votes[targetIdx] = (STATE.game.chaos.votes[targetIdx] || 0) + 1;

        // Pr√≥ximo
        STATE.game.chaos.currentPickIdx++;
        this.nextChaosPicker();
    },

    resolveChaos() {
        document.getElementById('starter-info').innerHTML = "";
        const devilMsg = CONFIG.diabo.outro;
        document.getElementById('game-status').textContent = devilMsg;
        this.log(devilMsg);
        
        // Renderiza lista final antes dos tiros (para mostrar todos os emojis de medo)
        this.renderPlayersList();

        setTimeout(() => {
            // Sons de engatilhar (cock) escalonados
            const players = STATE.game.players;
            const shooters = STATE.game.chaos.queue;
            
            shooters.forEach((sIdx, i) => {
                setTimeout(() => AudioSys.play('cock'), i * 100);
            });

            // Disparo simult√¢neo ap√≥s o ultimo cock
            setTimeout(() => {
                // Altera√ß√£o L√≥gica de Som: Verificar se algu√©m dispara antes de tocar o som
                let anyBang = false;
                shooters.forEach(sIdx => {
                    const s = players[sIdx];
                    if (s.gun.chamber === s.gun.bullet) anyBang = true;
                });
                
                AudioSys.play(anyBang ? 'shot' : 'empty');

                if (anyBang) {
                    document.body.classList.add('shake-screen');
                    setTimeout(() => document.body.classList.remove('shake-screen'), 500);
                }

                // L√≥gica de resolu√ß√£o
                let deaths = [];
                
                shooters.forEach(shooterIdx => {
                    const shooter = players[shooterIdx];
                    // Verifica se atira
                    const isBang = (shooter.gun.chamber === shooter.gun.bullet);
                    const targetIdx = STATE.game.chaos.targets[shooterIdx];
                    
                    // Checa conquista: Deu ouvido ao mau (Atirou em quem o diabo mandou)
                    if (targetIdx === STATE.game.chaos.devilTarget) {
                        Logic.checkAchievements(shooter.name, { listenedToDevil: true }, true);
                    }

                    // Checa conquista: Sorte no Caos (Arma na 4+ e acertou outro)
                    if (isBang && shooter.gun.chamber >= 4) {
                        Logic.checkAchievements(shooter.name, { chaosLuckHit: true }, true);
                    }

                    if (isBang) {
                        // O TIRO SAIU!
                        
                        // 1. Reseta o atirador (Mata, recarrega e gira)
                        shooter.gun.chamber = 0;
                        shooter.shotsTaken = 0; // Zera contador visual
                        shooter.gun.bullet = Math.floor(Math.random() * 6); // Nova posi√ß√£o da bala

                        // 2. Identifica o alvo e mata se ainda estiver vivo
                        const target = players[targetIdx];
                        
                        // Se o alvo j√° n√£o morreu por outro tiro nesse mesmo turno
                        if (target.alive && !deaths.includes(target)) {
                            deaths.push(target);
                        }

                        // Checa Conquista: Agora sou eu e voc√™ (Mutuo)
                        // Se A atira em B, B atira em A, e ambos morrem.
                        const bIdx = targetIdx;
                        // Verifica se B atirou em A (shooterIdx) e se o tiro de B saiu
                        if (STATE.game.chaos.targets[bIdx] === shooterIdx) {
                            const shooterB = players[bIdx];
                            if (shooterB.gun.chamber === shooterB.gun.bullet) {
                                // Ambos se mataram
                                Logic.checkAchievements(shooter.name, { mutualChaosDeath: true }, false);
                                Logic.checkAchievements(target.name, { mutualChaosDeath: true }, false);
                            }
                        }

                    } else {
                        // O TIRO FALHOU (CLICK)
                        shooter.gun.chamber++;
                        shooter.shotsTaken++; // Sobe contador visual
                    }
                });

                // Processa as mortes
                deaths.forEach(d => {
                    d.alive = false;
                    if (!STATE.stats[d.name]) STATE.stats[d.name] = { wins:0, hits:0, dodges:0 };
                    STATE.stats[d.name].hits++;
                    STATE.stats[d.name]._meta = { ...STATE.stats[d.name]._meta, dieStreak: (STATE.stats[d.name]._meta?.dieStreak || 0) + 1, winStreak: 0 };
                    // Como √© caos, o diedOnShot pega o valor atual (que n√£o mudou para quem morreu, apenas para quem atirou e errou)
                    Logic.checkAchievements(d.name, { diedOnShot: d.shotsTaken }, true); 
                });

                // Checa conquista Inimigo P√∫blico (Alvo de 3+ e sobreviveu)
                Object.keys(STATE.game.chaos.votes).forEach(tIdxStr => {
                    const tIdx = parseInt(tIdxStr);
                    const p = players[tIdx];
                    if (p.alive && STATE.game.chaos.votes[tIdx] >= 3) {
                        Logic.checkAchievements(p.name, { publicEnemySurvived: true }, true);
                    }
                });
                
                // Incrementa contador da mesa (apenas 1 para a rodada de caos)
                STATE.game.mesaShots++;

                // Logs e Falas Finais
                this.renderPlayersList();
                
                let resultMsg = "";
                const rConf = CONFIG.diabo.results;
                if (deaths.length === 0) {
                    // Sorteia frase se ningu√©m morrer
                    resultMsg = rConf.none[Math.floor(Math.random() * rConf.none.length)];
                }
                else if (deaths.length < 3) resultMsg = rConf.one[0];
                else resultMsg = rConf.many[0];

                document.getElementById('game-status').textContent = resultMsg;
                this.log(resultMsg);
                if (deaths.length > 0) this.log(`üíÄ Mortos no Caos: ${deaths.map(d=>d.name).join(', ')}`);

                // Finaliza√ß√£o
                setTimeout(() => {
                    // Limpa estado caos
                    STATE.game.chaos.active = false;
                    STATE.game.isShooting = false;
                    STATE.game.chaos.votes = {};

                    const alive = players.filter(p => p.alive);
                    if (alive.length <= 1) {
                         this.checkGameFlow(0); // For√ßa check de vit√≥ria
                    } else {
                        // Novo sorteio para quem come√ßa as cartas
                        const nextStart = alive[Math.floor(Math.random() * alive.length)];
                        STATE.game.turnIndex = players.indexOf(nextStart);
                        this.updateGameUI();
                        this.log(`üé≤ O destino escolheu ${nextStart.name} para recome√ßar.`);
                    }
                }, 4000);

            }, 1000 + (shooters.length * 100));

        }, 2000); // tempo de leitura da frase final do diabo
    },

    /* --- FIM L√ìGICA MODO CAOS --- */

    triggerMassacre(protectedIdx) {
        if (STATE.game.isShooting) return;
        STATE.game.isShooting = true; STATE.game.isMassacre = true; STATE.game.protectedIdx = protectedIdx;
        this.duelMode = false; 
        const players = STATE.game.players;
        this.renderPlayersList();
        document.getElementById('game-status').textContent = "‚ò†Ô∏è Isso vai ser interessante.";
        this.log(`‚ò†Ô∏è Morte: Isso vai ser interessante.`);
        const delays = [300, 350, 400, 450, 500, 550];
        let deaths = []; let massacreDeathsCount = 0;

        players.forEach((p, idx) => {
            if (idx !== protectedIdx && p.alive) {
                const delay = delays[Math.floor(Math.random() * delays.length)];
                setTimeout(() => { AudioSys.play('cock'); }, delay);
                setTimeout(() => {
                    const isDeath = p.gun.chamber === p.gun.bullet;
                    AudioSys.play(isDeath ? 'shot' : 'empty');
                    if (!isDeath) {
                        if (p.gun.chamber === 5) Logic.checkAchievements(p.name, { chaosSurvivor: true }, true);
                        p.gun.chamber++;
                    }
                    p.shotsTaken++;
                    if (isDeath) {
                        deaths.push(p.name); p.alive = false; massacreDeathsCount++;
                        if (!STATE.stats[p.name]) STATE.stats[p.name] = { wins:0, hits:0, dodges:0 };
                        STATE.stats[p.name].hits++;
                        STATE.stats[p.name]._meta = { ...STATE.stats[p.name]._meta, dieStreak: (STATE.stats[p.name]._meta?.dieStreak || 0) + 1, winStreak: 0 };
                        Logic.checkAchievements(p.name, { diedOnShot: p.shotsTaken }, true);
                    } else {
                        if (!STATE.stats[p.name]) STATE.stats[p.name] = { wins:0, hits:0, dodges:0 };
                        STATE.stats[p.name].dodges++;
                    }
                    this.renderPlayersList();
                }, 3000 + delay);
            }
        });

        setTimeout(() => {
            STATE.game.mesaShots++;
            if (massacreDeathsCount >= 3) {
                const protectedP = players[protectedIdx];
                if (protectedP && protectedP.alive) Logic.checkAchievements(protectedP.name, { isMassacre: true, massacreDeaths: massacreDeathsCount }, true);
            }
            STATE.game.isMassacre = false; STATE.game.lastProtectedIdx = protectedIdx; STATE.game.protectedIdx = null;
            this.renderPlayersList();

            let msg = "";
            if (deaths.length === 0) msg = "‚ò†Ô∏è Hum...";
            else if (deaths.length === 1) { msg = "‚ò†Ô∏è Vem eu te levo."; this.log(`‚ò†Ô∏è ${deaths[0]} foi de arrasta!`); }
            else {
                const causerIdx = (STATE.game.lastProtectedIdx + 1) % players.length;
                const causerName = players[causerIdx].name;
                msg = `‚ò†Ô∏è Obrigado! ${causerName}`; this.log(`‚ò†Ô∏è Massacre! Mortos: ${deaths.join(', ')}`);
            }
            document.getElementById('game-status').textContent = msg; if (msg) this.log(msg);
            if (deaths.length > 0) { document.body.classList.add('shake-screen'); setTimeout(() => document.body.classList.remove('shake-screen'), 500); }

            let nextTurn = (STATE.game.lastProtectedIdx + 2) % players.length;
            setTimeout(() => {
                const aliveCount = players.filter(p => p.alive).length;
                if (aliveCount <= 1) this.checkGameFlow(STATE.game.lastProtectedIdx);
                else {
                    while (!players[nextTurn].alive) nextTurn = (nextTurn + 1) % players.length;
                    STATE.game.turnIndex = nextTurn; STATE.game.isShooting = false;
                    if (Logic.rotateTable()) this.runRotationAnim(false); else this.updateGameUI();
                }
            }, 3000);
        }, 4000);
    },
    handleShoot(pIndex) {
        if (this.duelMode) { this.triggerMassacre(pIndex); return; }
        if (STATE.game.isShooting) return;
        STATE.game.isShooting = true;
        this.renderPlayersList();

        const p = STATE.game.players[pIndex];
        const frases = CONFIG.perfis[p.perfil];
        const fraseBefore = frases.before[p.lines.before++ % frases.before.length];
        const emoji = CONFIG.emojis[p.perfil] || '';

        document.getElementById('game-status').textContent = `${emoji} ${fraseBefore}`;
        this.log(`${emoji} ${p.name}: ${fraseBefore}`);

        // Capture state before shot for "Hope Last Dies" check
        const chamberBefore = p.gun.chamber;

        setTimeout(() => {
            AudioSys.play('cock'); 
            setTimeout(() => {
                const isDeath = p.gun.chamber === p.gun.bullet;
                AudioSys.play(isDeath ? 'shot' : 'empty');
                if (!isDeath) p.gun.chamber++;
                p.shotsTaken++; STATE.game.mesaShots++;
                if (isDeath) { document.body.classList.add('shake-screen'); setTimeout(() => document.body.classList.remove('shake-screen'), 500); }
                this.renderPlayersList();

                if (isDeath) {
                    const narrConf = CONFIG.narradores[STATE.game.narrator];
                    const killByPerfil = (narrConf.killLines && narrConf.killLines[p.perfil]) ? narrConf.killLines[p.perfil] : narrConf.killLines.default;
                    const narrEmoji = CONFIG.emojis[STATE.game.narrator] || 'üíÄ';
                    document.getElementById('game-status').textContent = `${narrEmoji} ${killByPerfil}`;
                    this.log(`${narrEmoji} ${killByPerfil}`);
                    p.alive = false; this.log(`üíÄ ${p.name} foi de arrasta!`);
                    if (!STATE.stats[p.name]) STATE.stats[p.name] = { wins:0, hits:0, dodges:0 };
                    STATE.stats[p.name].hits++;
                    STATE.stats[p.name]._meta = { ...STATE.stats[p.name]._meta, dieStreak: (STATE.stats[p.name]._meta?.dieStreak || 0) + 1, winStreak: 0 };
                    
                    // Checa conquistas de morte
                    const events = { diedOnShot: p.shotsTaken };
                    
                    // A Esperan√ßa √© a √∫ltima que morre...
                    // Se morreu na bala 1 (chamber 0), e antes (chamberBefore) veio de um reset ap√≥s 5?
                    // Como a arma reseta apenas se disparar, isso n√£o se aplica aqui no modo normal de roleta.
                    // Mas se ele sobreviveu ao CAOS com 5/6 (chamber 5), a arma N√ÉO reseta no caos se ele n√£o atirar.
                    // Se ele atirou e errou no caos, chamber foi pra 5+1 -> 6 (impossivel, roleta 0-5).
                    // Vamos considerar a l√≥gica: Sobreviveu ao caos com 5/6 significa que ele estava na 5, clickou (foi pra 0 na l√≥gica ciclica ou reset manual?).
                    // No c√≥digo do Chaos: "if (!isBang) shooter.gun.chamber++;".
                    // Se chamber era 5, vira 6. Na roleta real volta a 0? O c√≥digo n√£o trata "chamber % 6".
                    // Vamos assumir que se chamber > 5, reseta.
                    
                    Logic.checkAchievements(p.name, events, true);
                    setTimeout(() => { this.checkGameFlow(pIndex); }, 4000);
                } else {
                    const deathLine = STATE.game.deathLinesDeck[STATE.game.deathLineIdx % STATE.game.deathLinesDeck.length];
                    STATE.game.deathLineIdx++;
                    document.getElementById('game-status').textContent = `‚ò†Ô∏è ${deathLine}`; this.log(`‚ò†Ô∏è ${deathLine}`);
                    setTimeout(() => {
                        const fraseAfter = frases.afterSurvive[p.lines.afterSurvive++ % frases.afterSurvive.length];
                        document.getElementById('game-status').textContent = `${emoji} ${fraseAfter}`;
                        this.log(`${emoji} ${p.name}: ${fraseAfter}`);
                        if (!STATE.stats[p.name]) STATE.stats[p.name] = { wins:0, hits:0, dodges:0 };
                        STATE.stats[p.name].dodges++;
                        
                        // Checa √öltimo Suspiro (Sobreviveu ao chamber 5)
                        // Se chamber agora √© 6 (pq incrementou), ent√£o sobreviveu ao 5.
                        // Ou se chamber era 5.
                        // Pela l√≥gica: if (!isDeath) p.gun.chamber++;
                        // Se p.gun.chamber √© 5 AGORA, significa que ele sobreviveu ao 4.
                        // Se p.gun.chamber √© 6, sobreviveu ao 5.
                        Logic.checkAchievements(p.name, { didDodgeLastShotBefore: (p.gun.chamber === 6 || p.gun.chamber === 5) }, true);
                        
                        // Safety reset chamber if > 5
                        if (p.gun.chamber > 5) p.gun.chamber = 0; 

                        setTimeout(() => { this.checkGameFlow(pIndex); }, 3000);
                    }, 1500);
                }
            }, 3500);
        }, 300);
    },
    checkGameFlow(lastShooterIdx) {
        const alive = STATE.game.players.filter(p => p.alive);
        if (alive.length <= 1) {
            const winner = alive[0]; STATE.game.active = false;
            STATE.game.players.forEach(p => {
                if(!STATE.stats[p.name]) STATE.stats[p.name] = { wins:0, hits:0, dodges:0, matches: 0 };
                STATE.stats[p.name].matches = (STATE.stats[p.name].matches || 0) + 1;
                Logic.checkAchievements(p.name, {}, false);
            });
            if (winner) {
                if(!STATE.stats[winner.name]) STATE.stats[winner.name] = { wins:0, hits:0, dodges:0, matches: 0 };
                STATE.stats[winner.name].wins++;
                const meta = STATE.stats[winner.name]._meta || {};
                STATE.stats[winner.name]._meta = { ...meta, winStreak: (meta.winStreak||0)+1, dieStreak: 0 };
                
                const winnerIdx = STATE.game.players.indexOf(winner);
                const wasProtected = (STATE.game.lastProtectedIdx === winnerIdx);
                
                // Conquista: Um p√© na cova (Ganhou com chamber alto)
                // Se chamber >= 5.
                const didWinLastShotBefore = (winner.gun.chamber >= 5);

                const winEvents = { winStreak: STATE.stats[winner.name]._meta.winStreak, wasProtectedWinner: wasProtected, didWinLastShotBefore: didWinLastShotBefore };
                Logic.checkAchievements(winner.name, winEvents, true);
                
                const narrConf = CONFIG.narradores[STATE.game.narrator];
                const winnerLines = narrConf.winner || [];
                const chosen = winnerLines.length ? winnerLines[Math.floor(Math.random()*winnerLines.length)] : `${winner.name} venceu!`;
                const lined = chosen.replace('{nome}', winner.name);
                document.getElementById('win-msg').textContent = `${CONFIG.emojis[STATE.game.narrator] || ''} ${lined}`;
                
                const achDiv = document.getElementById('win-achievements'); achDiv.innerHTML = '';
                if (STATE.game.roundUnlocks.length > 0) {
                    achDiv.innerHTML = '<p>Novas Conquistas:</p>';
                    STATE.game.roundUnlocks.forEach(id => {
                        const def = ACHIEVEMENTS_DEF.find(a=>a.id===id);
                        if(def) achDiv.innerHTML += `<div style="font-size:0.9rem">${def.emoji} ${def.name}</div>`;
                    });
                }
            } else {
                document.getElementById('win-msg').textContent = "Ningu√©m sobrou nessa mesa maldita.";
            }
            Storage.set('stats', STATE.stats); STATE.game.isShooting = false;
            setTimeout(() => { this.goTo('win'); }, 1000);
            return;
        }
        STATE.game.isShooting = false;
        if (Logic.rotateTable()) { this.runRotationAnim(false); this.setNextTurn(lastShooterIdx); } 
        else { this.setNextTurn(lastShooterIdx); this.updateGameUI(); }
    },
    setNextTurn(currentIdx) {
        let next = (currentIdx + 1) % STATE.game.players.length;
        while (!STATE.game.players[next].alive) next = (next + 1) % STATE.game.players.length;
        STATE.game.turnIndex = next;
    },
    restartGame() { this.showLoading(); },
    updateGameUI() {
        document.getElementById('game-mesa-info').textContent = `Mesa de ${STATE.game.mesaCard}`;
        const cardDisplay = document.getElementById('game-mesa-card');
        const imgName = CONFIG.cards[STATE.game.mesaCard] || 'card-back.png';
        cardDisplay.style.backgroundImage = `url('${CONFIG.paths.img}${imgName}')`;
        document.getElementById('game-status').textContent = "";
        document.getElementById('game-narrator-area').textContent = "";
        
        const pName = STATE.game.players[STATE.game.turnIndex].name;
        document.getElementById('starter-info').innerHTML = `‚òÖ <b>${pName}</b> come√ßa essa baga√ßa`;
        this.renderPlayersList();
    },
    renderPlayersList() {
        const list = document.getElementById('game-players-list'); list.innerHTML = '';
        const btnDuel = document.getElementById('btn-duel-toggle');
        const btnChaos = document.getElementById('btn-chaos-toggle');
        
        // Controles de visibilidade dos bot√µes de modo
        if (!STATE.game.isShooting && !STATE.game.chaos.active) {
            btnDuel.style.display = STATE.game.massacreMode ? 'block' : 'none';
            // Ajuste: Bot√£o Caos s√≥ aparece se ativado no setup
            btnChaos.style.display = STATE.game.chaosMode ? 'block' : 'none';
        } else {
            // Se estiver em modo caos ativo, esconde
            if (STATE.game.chaos.active) {
                btnDuel.style.display = 'none';
                btnChaos.style.display = 'none';
            }
        }

        const isChaosSel = STATE.game.chaos.active;
        let pickerIdx = -1;
        if (isChaosSel && STATE.game.chaos.queue.length > 0 && STATE.game.chaos.currentPickIdx < STATE.game.chaos.queue.length) {
            pickerIdx = STATE.game.chaos.queue[STATE.game.chaos.currentPickIdx];
        }

        STATE.game.players.forEach((p, idx) => {
            const isStarter = (idx === STATE.game.turnIndex);
            
            // L√≥gica de Emoji no Caos
            let displayEmoji = p.alive ? CONFIG.emojis[p.perfil] : 'üíÄ';
            if (p.alive && isChaosSel) {
                const votes = STATE.game.chaos.votes[idx] || 0;
                if (votes === 1) displayEmoji = "üòü";
                else if (votes === 2) displayEmoji = "üò®";
                else if (votes >= 3) displayEmoji = "üò±";
            }

            // Destaque do atirador no Caos
            const isChaosPicker = (idx === pickerIdx);
            
            const div = document.createElement('div');
            div.className = `player-card ${!p.alive ? 'dead' : ''} ${isStarter && !isChaosSel ? 'starter' : ''} ${isChaosPicker ? 'chaos-highlight' : ''}`;
            
            let btnHtml = '';
            if (!p.alive) {
                btnHtml = '<span class="shot-glass" style="display:none;"></span>';
            } else {
                if (isChaosSel) {
                    // Modo Caos
                    if (isChaosPicker) {
                        btnHtml = `<button class="western-btn small" style="background:#444; color:#fff;" disabled>üî´ Atirador</button>`;
                    } else {
                        // Se for um alvo v√°lido (n√£o √© ele mesmo)
                        if (pickerIdx !== -1) {
                             btnHtml = `<button class="western-btn btn-aim small" onclick="App.handleChaosPick(${idx})">üéØ Mirar</button>`;
                        } else {
                             // Fase de resolu√ß√£o, sem bot√µes
                             btnHtml = `<span style="font-size:1.5rem">ü•∂</span>`;
                        }
                    }
                } else if (STATE.game.isMassacre) {
                    if (idx === STATE.game.protectedIdx) btnHtml = `<button class="western-btn btn-protect small" disabled>üïäÔ∏è Protegido</button>`;
                    else btnHtml = `<button class="western-btn btn-fire small" disabled>üî• FOGO</button>`;
                } else if (this.duelMode) {
                    btnHtml = `<button class="western-btn btn-protect small" ${STATE.game.isShooting ? 'disabled' : ''} onclick="App.handleShoot(${idx})">üïäÔ∏è Protegido</button>`;
                } else {
                    btnHtml = `<button class="western-btn danger small" ${STATE.game.isShooting ? 'disabled' : ''} onclick="App.handleShoot(${idx})">ATIRAR</button>`;
                }
            }
            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <span class="emoji-big">${displayEmoji}</span>
                    <div><div style="font-weight:bold; font-size:1.3rem">${p.name}</div></div>
                </div>
                <div style="display:flex; align-items:center; gap: 10px;">
                     <div style="font-size:1.2rem; font-weight:bold; opacity:0.8">${p.shotsTaken}/6</div>
                    ${btnHtml}
                </div>
            `;
            list.appendChild(div);
        });
    },
    log(msg) {
        const box = document.getElementById('game-log');
        box.innerHTML += `<div>${msg}</div>`; box.scrollTop = box.scrollHeight;
    },
    renderStats() {
        const board = document.getElementById('stats-board');
        const list = Object.keys(STATE.stats).sort((a,b)=>STATE.stats[b].wins - STATE.stats[a].wins);
        if (list.length === 0) { board.innerHTML = '<p class="text-center">Ainda n√£o h√° lendas neste bar.</p>'; return; }
        board.innerHTML = '';
        list.forEach(name => {
            const s = STATE.stats[name]; const achs = STATE.achieved[name] || [];
            let html = `<div style="margin-bottom:15px; border-bottom:1px dashed #555; padding-bottom:10px;">
                <div style="font-weight:bold; color:var(--gold); display:flex; justify-content:space-between; align-items:center;">
                    <span>${name} ${achs.length > 0 ? '‚≠ê' : ''}</span>
                    <button class="western-btn secondary small" style="margin:0; width:auto; font-size:0.7rem;" onclick="App.viewPlayerAch('${name}')">VER CONQUISTAS</button>
                </div>
                <div style="font-size:0.9rem; margin-top:5px;">üèÜ ${s.wins} | ‚ò†Ô∏è ${s.hits} | üçÄ ${s.dodges} | ü§† ${s.matches || 0}</div>
                <div style="margin-top:5px; font-size:0.8rem;">
                    ${achs.map(id => { const def = ACHIEVEMENTS_DEF.find(a=>a.id===id); return def ? def.emoji : ''; }).join(' ')}
                </div>
            </div>`;
            board.innerHTML += html;
        });
    },
    viewPlayerAch(name) {
        document.getElementById('ach-screen-title').textContent = `Conquistas: ${name}`;
        const container = document.getElementById('ach-list-content'); container.innerHTML = '';
        const unlocked = STATE.achieved[name] || [];
        const sorted = [...ACHIEVEMENTS_DEF].sort((a,b) => {
            const hasA = unlocked.includes(a.id); const hasB = unlocked.includes(b.id);
            if (hasA && !hasB) return -1; if (!hasA && hasB) return 1; return 0;
        });
        sorted.forEach(ach => {
            const has = unlocked.includes(ach.id); if(!has && ach.isHidden) return;
            const div = document.createElement('div'); div.className = `ach-row ${has ? '' : 'locked'}`;
            div.innerHTML = `<div style="font-size:1.5rem;">${has ? ach.emoji : 'üîí'}</div>
                <div><div style="font-weight:bold; color:${has ? 'var(--gold)' : '#aaa'}">${ach.name}</div>
                <div style="font-size:0.8rem;">${ach.desc}</div></div>`;
            container.appendChild(div);
        });
        this.goTo('achievements');
    },
    confirmResetStats() {
        View.showModal("QUEIMAR REGISTROS?", "Isso apagar√° todas as vit√≥rias e conquistas para sempre.", [
            { text: "SIM, QUEIME TUDO", class: "danger", action: () => {
                STATE.stats = {}; STATE.achieved = {}; STATE.db = []; STATE.slots = [null,null,null,null,null,null];
                Storage.set('stats',{}); Storage.set('achieved',{}); Storage.set('db',[]); Storage.set('slots', STATE.slots);
                this.renderStats(); View.closeModal();
            }},
            { text: "CANCELAR", class: "secondary", action: () => View.closeModal() }
        ]);
    },
    confirmDeletePlayer(name) {
        View.showModal("EXPULSAR DO BAR?", `Deseja remover "${name}" permanentemente?`, [
            { text: "FORA DAQUI!", class: "danger", action: () => {
                STATE.db = STATE.db.filter(n=>n!==name);
                STATE.slots = STATE.slots.map(s => s === name ? null : s);
                Storage.set('db', STATE.db); Storage.set('slots', STATE.slots);
                this.openSelect(this.currentSlot); View.closeModal();
            }},
            { text: "DEIXA ELE", class: "secondary", action: () => View.closeModal() }
        ]);
    }
};

/* --- VIEW HELPER --- */
const View = {
    showModal(title,msg,buttons) {
        const m = document.getElementById('customModal');
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = msg;
        const act = document.getElementById('modalActions'); act.innerHTML = '';
        buttons.forEach(b => {
            const btn = document.createElement('button'); btn.textContent = b.text; btn.className = `western-btn ${b.class}`; btn.onclick = b.action; act.appendChild(btn);
        });
        m.classList.add('active');
    },
    closeModal() { document.getElementById('customModal').classList.remove('active'); },
    showToast(pName, ach) {
        const t = document.getElementById('achievementToast');
        document.getElementById('achPlayerName').textContent = pName;
        document.getElementById('achEmoji').textContent = ach.emoji;
        document.getElementById('achName').textContent = ach.name;
        t.classList.add('show');
        setTimeout(()=>t.classList.remove('show'), 3500);
    }
};

/* BOOTSTRAP */
window.App = App;
App.init();

</script>
</body>
</html>